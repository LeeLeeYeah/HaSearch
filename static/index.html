<!DOCTYPE HTML>
<html>

<head>
	<title>HaSearch</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- CSS -->
	<link href="static/css/my.css" rel='stylesheet' type='text/css' />
	<link href="static/css/bootstrap.min.css" rel='stylesheet' type='text/css' />
	<!-- JQuery -->
	<script src="static/js/jquery.min.js"></script>
	<!-- React JavaScript -->
	<script src="static/js/react.js"></script>
	<script src="static/js/react-dom.js"></script>
	<script src="static/js/browser.min.js"></script>
</head>

<body>
	<div id='container'></div>
	<script type='text/babel'>
		'usestrict';
		const enterKeycode = 13;

		var Results = React.createClass({
			render: function(){
				return(
					<ul>{
						this.props.data.map(function(value,i){
							return(
								<li key={i}>
									{value}
								</li>
							);
						})
					}</ul>
				);
			}
		});

		var MainFrame = React.createClass({
			getInitialState:function(){
				return{
					stage:'prepare',
					chose:1,
					correct:'',
					input:'',
					time:0,
					resList:[]
				}
			},
			runSearch: function(input){
				var base64 = btoa(input);
				var beginT = new Date(); 
				$.get('/api/correctsearch?words='+base64).done(
					function(res){
						var endT = new Date();
						//console.log(res);
						if(res.status===1){
							this.setState({correct:res.query});
						}else {
							this.setState({correct:''});
						}
						var cost = (endT.getTime() - beginT.getTime())/1000;
						this.setState({resList:res.result,time:cost});
					}.bind(this)
				)
				if(this.state.stage==='prepare'){
					this.setState({stage:'show',input:input});
				}
			},
			tip: function(){
				if(this.state.correct!==''){
					return(
						<div>
							<span className="searchTip">Did you mean?</span>
							<br/>
							<span className="promptWords">{this.state.correct}</span>
						</div>
					);
				}else{
					return(<div/>);
				}
			},
			changeChose:function(value){
				this.setState({chose:value});
			},
			render: function(){
				if(this.state.stage==='prepare'){
					return(
						<div className="indexFrame">
							<div className="firstLogoDiv">
								<img className="firstLogo" src="static/images/logo.jpg" alt="HaSearch"/>
							</div>
							<AutoSuggest runSearch={this.runSearch} input={this.state.input}/>
						</div>
					);
				}else{
					// some caculation
					var chose = this.state.chose;
					var end = this.state.chose*10;
					var data = this.state.resList.slice(end-10,end);
					var num = Math.ceil(this.state.resList.length/10);
					var arr = [];
					var changeChose = this.changeChose;
					for(var i=1;i<=num;i++)
						arr.push(i);
					return(
						<div className="resultFrame">
							<div className="searchBar">
								<div className="smLogo"><img className="smLogo" src="static/images/smLogo.png" alt="HaSearch"/></div>
								<div id='another'>
									<AutoSuggest runSearch={this.runSearch}  input={this.state.input}/>
								</div>
							</div>
							<div className="resultList">
								<p id="searchTime">About {this.state.resList.length||''} results ({this.state.time} seconds)</p>
								{this.tip()}
								<hr></hr>
								<Results data={data}/>
								<hr></hr>
								<div className="resultChose">
									{
										arr.map(function(i){
											if(i===chose){
												return(<a key={i} className='chosedItem'>{i}</a>);
											}else{
												return(<a key={i} className='unchosedItem' onClick={changeChose.bind(null,i)}>{i}</a>);
											}
										})
									}
								</div>
							</div>
						</div>
					);
				}
			}
		});
		var AutoSuggest = React.createClass({
			getInitialState:function(){
				return{
					input:this.props.input
				};
			},
			onKeyDown:function(event){
				if(event.keyCode===13){
					this.props.runSearch(this.state.input);
				}
			},
			onChange:function(event){
				this.setState({input:event.target.value});
			},
			rowClick:function(){
				this.props.runSearch(this.state.input);
			},
			render: function(){
				return(
					<div className="searchInputWrapper">
						<div id="keywordsInput">
							<input className='initWords' type="text" onKeyDown={this.onKeyDown} value={this.state.input} onChange={this.onChange} autoFocus='true'/>
						</div>
						<div className='buttonsWrapper'>
							<input className="myBtn" type="button" value="Row" onClick={this.rowClick}/>
						</div>
					</div>
				);
			}
		});

		// render
		ReactDOM.render(<MainFrame/>,document.getElementById('container'));
	</script>
</body>
</html>
